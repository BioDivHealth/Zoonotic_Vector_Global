---
title: "RESPONSES OF ZOONOTIC DISEASE TO GLOBAL CHANGE"
author: "David Redding"
date: "17 January 2019"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(data.table)
require(ggplot2)
require(viridis)
```

How zoonotic diseases will respond as a whole to global change is uncertain. Much of the change will be down to ecological responses of host and vector species. Here, I examine how the 'arena of contact' (defined as the overlap of B & E in Fig. 1) for zoonotic diseases will change from present day to four future time points: 2030,2050,2070 and 2080. While futher complexties within each disease may mean some of these predicted changes do not manafest, these result show the prevailing direct of change.

![Fig 1. Systems models of human zoonoses](C:/Users/David/Dropbox/presentations/conceptual_model10.jpg)

```{r Inputs}
##read in
files<-list.files("C:\\Users\\David\\Dropbox\\New_Global_MAXENT\\results2",full.names=TRUE)
print("Number of diseases in summary:")
length(files)
```

```{r echo=FALSE}

for (i in 1:length(files)){
  
  load(files[i])
  res9$filen<-files[i]
  if(i==1) {res10<-res9} else {res10<-rbind(res10,res9)}
}

##rename
dat1<-as.data.frame(res10)

##add in filen
#dat1$filen<-files

### cinvert to numeric
dat1$year<-as.numeric(dat1$year)

##remove duplicates
dat1<-dat1[!duplicated(dat1),]

##create main values
dat1$mean<-((dat1$future_realised_change_upper-dat1$future_realised_change_lower)/2)+dat1$future_realised_change_lower
dat1$sd<-(dat1$future_realised_change_upper-dat1$future_realised_change_lower)/4

###also for climate only data (so no SSP!)
dat1$climmean<-((dat1$future_realised_clim_upper-dat1$future_realised_clim_lower)/2)+dat1$future_realised_clim_lower
dat1$climsd<-(dat1$future_realised_clim_upper-dat1$future_realised_clim_lower)/4

##create zero for present day
dat1a<-dat1[dat1$year==2030,]
dat1a$year<-2015
#dat1a[, c("RCP","ssp") ]<-0
dat1a[, c("mean","sd","climmean","climsd","future_realised_upper","future_realised_lower","future_realised_clim_upper","future_realised_clim_lower","future_realised_change_upper","future_realised_change_lower")]<-0
dat1<-rbind(dat1,dat1a)

###creat RCP SSP unique?
dat1$RCPSSP<-paste(dat1$RCP,dat1$ssp)
dat1$diseaseRCPSSP<-paste(dat1$name,dat1$RCP,dat1$ssp)
dat1$diseaseRCPSSPyear<-paste(dat1$name,dat1$RCP,dat1$ssp,dat1$year)
dat1$diseaseRCPSSPyearmean<-paste(dat1$name,dat1$RCP,dat1$ssp,dat1$year,dat1$mean)

##remove duplicates2
dat1<-dat1[!duplicated(dat1$diseaseRCPSSPyearmean),]

##remove duplicates3
dat1<-dat1[order(dat1$mean,decreasing=TRUE),]
dat1<-dat1[!duplicated(dat1$diseaseRCPSSPyear),]

#dat1b<-aggregate(dat1$mean,by=list(dat1$diseaseRCPSSP),max)
#dat1c<-aggregate(dat1$mean,by=list(dat1$diseaseRCPSSP),min)
dat1d<-aggregate(dat1$mean,by=list(dat1$diseaseRCPSSP),function (x) max(abs(x)))

### find maximum for each disease and then create a value relative to that maximum
dat1<-merge(dat1,dat1d,by.x="diseaseRCPSSP",by.y="Group.1")
dat1$true_mean<-dat1$mean/dat1$x

##simplify
dat1$Type2<-gsub("HUMAN->HUMAN","HUMAN",dat1$Type)
dat1$Type2<-gsub("HOST->VECTOR->HUMAN->VECTOR->HUMAN","HUMAN->VECTOR->HUMAN",dat1$Type2)

dat1$Type3<-dat1$Type2
dat1$Type3<-gsub("HUMAN->VECTOR->HUMAN","VECTORED",dat1$Type3)
dat1$Type3<-gsub("HOST->VECTOR->HUMAN","VECTORED",dat1$Type3)
dat1$Type3<-gsub("HOST->HUMAN","NONVECTORED",dat1$Type3)

###
require(maptools)
data(wrld_simpl)
wrld_simpl[wrld_simpl$NAME=="Taiwan","REGION"]<-142
wrld_simpl[wrld_simpl$NAME=="Taiwan","SUBREGION"]<-30
wrld_simpl<-wrld_simpl[wrld_simpl$REGION!=0,]


dat1$REGIONS<-NA
dat1$SUBREGIONS<-NA
dat1$AREA<-NA
dat1$POPULATIONATRISK<-NA
dat1$max_lat<-NA
dat1$min_lat<-NA

for(x in 1:nrow(dat1)){
  tt<-dat1$countries[x]
  ws2<-wrld_simpl[wrld_simpl$ISO2 %in% strsplit(tt,",")[[1]],]@data
  if(nrow(ws2)==0){next}
  ws2<-ws2[order(ws2$REGION,ws2$SUBREGION),]
  dat1$REGIONS[x]<-paste0(unique(ws2$REGION),collapse=",")
  dat1$SUBREGIONS[x]<-paste0(unique(ws2$SUBREGION),collapse=",")
  dat1$AREA[x]<-sum(ws2$AREA,na.rm=TRUE)
  dat1$POPULATIONATRISK[x]<-sum(ws2$POP2005,na.rm=TRUE)
  dat1$max_lat[x]<-max(ws2$LAT,na.rm=TRUE)
  dat1$min_lat[x]<-min(ws2$LAT,na.rm=TRUE)
}

###
dat1$tropics<-"Wide"
dat1$tropics[dat1$max_lat>33 & dat1$min_lat<(-33)]<-"Global"
dat1$tropics[dat1$max_lat>33 & dat1$min_lat>0]<-"Northern"
dat1$tropics[dat1$max_lat<(0) & dat1$min_lat<(-33)]<-"Southern"
dat1$tropics[dat1$max_lat<33 & dat1$min_lat>(-33)]<-"Trop"

dat1$tropics2<-dat1$tropics
dat1$tropics2[dat1$tropics=="Southern"]<-"Temp"
dat1$tropics2[dat1$tropics=="Northern"]<-"Temp"
dat1$tropics2[dat1$tropics=="Global"]<-"Wide"


dat1$group3<-dat1$group
dat1$group3[regexpr('vir', dat1$group)!=(-1)]<-"virus"


##make into group and type
## not sure type has any explantory affect
dat1$groupType<-paste(dat1$Type2,dat1$group3,sep="_")

###read in all known AUCS
aucs<-read.csv("C:\\Users\\David\\Dropbox\\New_Global_MAXENT\\AUC1.csv")
aucs$files1<-gsub("X:\\DRtemp\\per_disease\\ ","",aucs$disease,fixed=TRUE)
aucs$files1<-gsub(" present.r","",aucs$files1)

###ad in AUC score 
### removes everything without an AUC <<<<
dat1<-merge(dat1,aucs,by.x="name",by.y="files1")

```
#Summary plots

Here are the results of the runs across all diseases, with response variable as the number of new cases, coloured by first SSP then RCP:
```{r}

ggplot(dat1[dat1$x<2e+08,], aes(x=year,y=mean,col=(ssp),group=diseaseRCPSSP))+
          geom_line(lwd=2,alpha=0.5)+
          theme_bw()+
          geom_abline(slope=0,intercept=0,lwd=1,lty=2)

ggplot(dat1[dat1$x<2e+08,], aes(x=year,y=mean,col=(-RCP),group=diseaseRCPSSP))+
          geom_line(lwd=2,alpha=0.5)+
          theme_bw()+
          geom_abline(slope=0,intercept=0,lwd=1,lty=2)



```


Here are the results of the runs across all diseases, with response variable as the relative change in cases, coloured by first SSP then RCP:

```{r}

ggplot(dat1, aes(x=year,y=true_mean,col=ssp,group=diseaseRCPSSP))+
          geom_line(lwd=1,alpha=0.1)+
          theme_bw()+
          geom_abline(slope=0,intercept=0,lwd=2,lty=2)
          
ggplot(dat1, aes(x=year,y=true_mean,col=(-RCP),group=diseaseRCPSSP))+
          geom_line(lwd=1,alpha=0.1)+
          theme_bw()+
          geom_abline(slope=0,intercept=0,lwd=2,lty=2)
```


The same summary but divide into sub-types of zoonotic disease:

```{r plots}

ggplot(dat1[dat1$group3=="bacteria" & dat1$AUC>=0.55,], aes(x=jitter(year,4),y=jitter(true_mean,0.01)))+
          #geom_line(size=1.5,alpha=0.1)+
          #geom_point()+
          geom_hex(bins=10)+
         facet_grid(tropics2~Type2,scales="free")+
          theme(strip.text.x = element_text(size = 7, colour = "black"))+
         theme_bw()+
          xlim(2025,2085)+
          geom_abline(slope=0,intercept = 0,lty=2)+
          labs(title="Bacteria")+
            scale_fill_viridis(direction=-1, trans = "log")


ggplot(dat1[dat1$group3=="virus"& dat1$AUC>=0.55,], aes(x=jitter(year,4),y=jitter(true_mean,0.01)))+
          #geom_line(size=1.5,alpha=0.1)+
          #geom_point()+
          geom_hex(bins=10,binwidth = c(5,0.25))+
         facet_grid(tropics2~Type2,scales="free")+
          theme(strip.text.x = element_text(size = 7, colour = "black"))+
         theme_bw()+
          xlim(2025,2085)+
          geom_abline(slope=0,intercept = 0,lty=2)+
          labs(title="Virus")+
          scale_fill_viridis(direction=-1, trans = "log")


ggplot(dat1[dat1$group3=="parasite" & dat1$AUC>=0.55,], aes(x=jitter(year,4),y=jitter(true_mean,0.01)))+
          #geom_line(size=1.5,alpha=0.1)+
          #geom_point()+
           geom_hex(bins=15,binwidth = c(5,0.25))+
         facet_grid(tropics2~Type2,scales="free")+
          theme(strip.text.x = element_text(size = 7, colour = "black"))+
         theme_bw()+
          xlim(2025,2085)+
          geom_abline(slope=0,intercept = 0,lty=2)+
          labs(title="Parasite")+
          scale_fill_viridis(direction=-1, trans = "log")






```

```{r}



ggplot(dat1[dat1$group3!="fungi" & dat1$AUC>=0.6,], aes(x=year,y=climmean,colour=group3,group=group3))+
          #geom_line(size=1,alpha=0.1)+
          geom_smooth(method="loess",span=5,alpha=0.15)+
          theme(strip.text.x = element_text(size = 7, colour = "black"))+
         theme_bw()+
          geom_abline(slope=0,intercept = 0,lty=2)+
           facet_grid(group3~tropics2,scales="free")



ggplot(dat1[dat1$group3!="fungi" & dat1$AUC>=0.6,], aes(x=year,y=(future_realised_upper-future_realised_lower)/2,colour=group3,group=group3))+
          #geom_line(size=1,alpha=0.1)+
          geom_smooth(method="loess",span=5,alpha=0.15)+
          theme(strip.text.x = element_text(size = 7, colour = "black"))+
         theme_bw()+
          geom_abline(slope=0,intercept = 0,lty=2)+
           facet_grid(group3~tropics2,scales="free")



ggplot(dat1[dat1$group3!="fungi" & dat1$AUC>=0.6,], aes(x=year,y=true_mean,colour=group3,group=group3))+
          #geom_line(size=1,alpha=0.1)+
          geom_smooth(method="loess",span=5,alpha=0.15)+
          theme(strip.text.x = element_text(size = 7, colour = "black"))+
         theme_bw()+
          geom_abline(slope=0,intercept = 0,lty=2)+
           facet_grid(group3~tropics2,scales="free")



ggplot(dat1[dat1$group3!="fungi" & dat1$AUC>=0.6,], aes(x=year,y=true_mean,group=name))+
          #geom_line(size=1,alpha=0.1)+
          geom_smooth(method="loess",colour="black",span=5,alpha=0.2)+
          theme(strip.text.x = element_text(size = 7, colour = "black"))+
         theme_bw()+
          geom_abline(slope=0,intercept = 0,lty=2,lwd=0.75)+
           facet_grid(~group3,scales="free")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

```



Again, the same summary but with raw climatic/niche differences:

```{r, warning=FALSE,message=FALSE}


ggplot(dat1, aes(x=year,y=climmean,colour=group3,group=diseaseRCPSSP))+
          geom_line(size=1,alpha=0.1)+
         facet_grid(tropics2~Type2,scales="free_y")+
          theme(strip.text.x = element_text(size = 7, colour = "black"))+
         theme_bw()+
          geom_abline(slope=0,intercept = 0,lty=2)

          #geom_smooth(span=0.1)+

ggplot(dat1, aes(x=year,y=true_mean,colour=group3,group=diseaseRCPSSP))+
          geom_line(size=1,alpha=0.1)+
         facet_grid(tropics2~Type2,scales="free_y")+
          theme(strip.text.x = element_text(size = 7, colour = "black"))+
         theme_bw()+
          geom_abline(slope=0,intercept = 0,lty=2)

```

```{r}

library(MASS)
library(vcd)

dat1$true_mean2<-cut(dat1$true_mean,breaks=5)
dat1$climmean2<-cut(dat1$climmean,breaks=5)


dat1$record<-1

freq1<-xtabs(data=dat1[dat1$AUC>=0.6,],record~tropics2+true_mean2+group3)

mosaic(freq1, shade=TRUE, legend=TRUE,main="Pathogen Group")


freq1<-xtabs(data=dat1[dat1$AUC>=0.6,],record~tropics2+climmean2+group3)

mosaic(freq1, shade=TRUE, legend=TRUE,main="Pathogen Group Climate")



freq1<-xtabs(data=dat1[dat1$group3=="virus" & dat1$AUC>=0.6,],record~Type2+true_mean2+tropics2)


mosaic(freq1, shade=TRUE, legend=TRUE,main="virus")

freq1<-xtabs(data=dat1[dat1$group3=="bacteria" & dat1$AUC>=0.6,],record~Type2+true_mean2+tropics2)


mosaic(freq1, shade=TRUE, legend=TRUE,main="bacteria")

freq1<-xtabs(data=dat1[dat1$group3=="parasite"& dat1$AUC>=0.6,],record~true_mean2+tropics2)


mosaic(freq1, shade=TRUE, legend=TRUE,main="Parasite")


#rr<-loglm(~true_mean2+Type2+tropics2+group3,data=freq1)


dat1$climmean2<-Hmisc::cut2(dat1$climmean,g=5,levels.mean=TRUE)

#dat1$climmean2<-cut(dat1$climmean,breaks=8)#,labels=TRUE)


dat1$record<-1

freq1<-xtabs(data=dat1,record~tropics2+climmean2+group3)

mosaic(freq1, shade=TRUE, legend=TRUE,main="Pathogen Group")


freq1<-xtabs(data=dat1,record~tropics2+climmean2+Type2)

mosaic(freq1, shade=TRUE, legend=TRUE,main="Transmission Route")

#freq1<-xtabs(data=dat1[dat1$Type2=="HUMAN->VECTOR->HUMAN",],record~tropics2+climmean2+group3)

#mosaic(freq1, shade=TRUE, legend=TRUE,main="HUMAN->VECTOR->HUMAN")




```

